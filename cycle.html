<!-- 
File CREATED: MAY 24, 2014
For birthday app, I initially auhthorized Google Calendar on my account Feburary 17, 2014


TO DO:
* refresh dates, after updating calendar

apiKey = 'AIzaSyBLYlu4hbmzhr1iOCiD_o2PTrjzvQBuQUA';


"RRULE:FREQ=WEEKLY;WKST=MO;UNTIL=20140612T223000Z;BYDAY=TH"
-->

<!DOCTYPE HTML>
<html>
<head>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/start/jquery-ui.css">
  <script src="//code.jquery.com/jquery-1.9.1.js"></script>
  <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
  <script src="http://d3js.org/d3.v3.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Michroma' rel='stylesheet' type='text/css'>
  <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
  <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="style.css">
  <script src="https://apis.google.com/js/client:plusone.js?onload=gapiLoaded" async defer></script>
  <script type="text/javascript">
  
  var Socialite = (function () {
    'use strict';
    
    var currentCalendar,
      lastPeriod,
      periodEvent,
      cycle_length,
      newLastPeriod,
      newInterval;
    
    function setCurrentCalendar(ev,ui){
    
      currentCalendar = ui.item.data("id");
      $("#select_calendar span.ui-button-text").text(ui.item.text());
      $("#select_calendar").blur();
      
      if(typeof(Storage)!=="undefined"){
        localStorage.currentCalendar=currentCalendar;
      }
    }
    
    function getNextOccurance(eventID){
      var currentDate = new Date();
        
      var request = gapi.client.calendar.events.instances({
          'calendarId': currentCalendar,
          'timeMin': currentDate.toISOString(),
          'eventId': eventID
      });
      
      request.execute(function(resp) {
        if(resp.error){ 
          alert("failed to find next occurance");
        }else{
          //TO DO: check if the instance is null
          var instanceDate = findNext(resp.items);
          $("#nextPeriod").text(instanceDate.toDateString());
          instanceDate.setDate(instanceDate.getDate()-cycle_length);
          $("#lastPeriod").text(instanceDate.toDateString());
          lastPeriod = instanceDate;
          $("#cycle-length-txt").text(cycle_length);
          
          $('#dateDisplays').show();
        }
      });
    }

    //makes sure it is actually an upcoming date (and not just that the end date is upcoming)
    function findNext(periodEvents){
      var startDate;
      var i;
      for ( i=0; i < periodEvents.length; i += 1){
        startDate = new Date(periodEvents[i].start.date);
        startDate.setMinutes(0 + startDate.getTimezoneOffset());
      
        if(startDate > new Date()){
      
          return startDate;
        }
      }
      
      return null;
    }


    function updateInterval(){
      newInterval=$( "#spinner" ).spinner( "value" );
      updateButtonText();
    }
  
    function updateLastPeriod(dateText, inst){
  
      newLastPeriod=dateText;
      updateButtonText();
    }
  
    function updateButtonText(){
      $("#newLastPeriodBtn").text("Reset Period to every " + newInterval + " days from " + newLastPeriod);
    }
  
    function getActualLast(){
  
      var today = new Date(newLastPeriod);
      if (today>(new Date(lastPeriod))){
        today = new Date(lastPeriod);
        today.setDate(today.getDate()-1);
      }
      var month = ("0" + (today.getMonth()+1)).slice(-2);
      var day = ("0" + today.getDate()).slice(-2);
      return today.getFullYear()+month + day;
    }
    
    function createNewPeriodEvent(){
      var periodStart = new Date(newLastPeriod);
      var startString = periodStart.toISOString().slice(0,10);
      periodStart.setDate(periodStart.getDate()+5);
      var endString = periodStart.toISOString().slice(0,10);
      var newEvent= {
        summary: "me time",
        recurrence: ["RRULE:FREQ=DAILY;INTERVAL=" + newInterval +";"],
        start: {date: startString},
        end: {date: endString}
      };
      var request = gapi.client.calendar.events.insert({
        'calendarId': currentCalendar,
        'resource': newEvent
      });
    
      request.execute(function(resp) {
    
        if(resp.error){ 
          alert("failed to insert");
        } else {    
          $("#dialog").dialog("close");
        }
      });
    }

    function draw_chart(data){
    
      var margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

      var x = d3.time.scale()
        .range([0, width]);
        
      var y = d3.scale.linear()
        .range([height, 0]);
        
      var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");
        
      var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");
        
      var svg = d3.select("#chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
      var formatCount = d3.format(",.0f");
      
      data.forEach(function(d) {
        d.close = +d.close;
      });
      
      x.domain(d3.extent(data, function(d) { return d.date; }));
      y.domain([0,d3.max(data, function(d) { return d.close; })*1.25]);
      y.nice(15);
      
      svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);
        
      svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Length (Days)");

      var bar = svg.selectAll(".bar")
        .data(data)
        .enter().append("g")
        .attr("class", "bar")
        .attr("transform", function(d) { return "translate(" + x(d.date) + "," + y(d.close) + ")"; });
        
      bar.append("rect")
        .attr("x", 1)
        .attr("width", function(d) { return x(new Date(1000*60*60*24*d.close))-x(0) ; })
        .attr("height", function(d) { return height - y(d.close); });
        
      bar.append("line")
        .attr("class", "line")
        .attr("x1", 0)
        .attr("y1", 0)
        .attr("x2", 0)
        .attr("y2", function(d) { return height - y(d.close); });
        
      bar.append("text")
        .attr("dy", ".75em")
        .attr("y", 6)
        .attr("x", function(d) { return x(new Date(1000*60*60*12*d.close))-x(0) ; })
        .attr("text-anchor", "middle")
        .text(function(d) { return formatCount(d.close); });
        
      bar.append("text")
        .attr("dy", ".75em")
        .attr("y", function(d) { return (height - y(d.close))/2; })
        .attr("x", 10)
        .attr("text-anchor", "left")
        .text(function(d) { return d.date.toDateString() + " to " + d.cycleEnded.toDateString();  })
        .call(wrap,function(d) { return (x(new Date(1000*60*60*24*d.close))-x(0)) * 2 ; });
    
      $(".bar").mouseover(function (){
        $(this).attr("class","bar info");
      });
      
      $(".bar").mouseout(function (){
        $(this).attr("class","bar");
      });
    }
    
    function wrap(text, width) {
    
      text.each(function(d) {
        var text = d3.select(this),
          words = text.text().split(/\s+/).reverse(),
          word,
          line = [],
          lineNumber = 0,
          lineHeight = 1.1, // ems
          y = text.attr("y"),
          dy = parseFloat(text.attr("dy")),
          tspan = text.text(null)
            .append("tspan")
            .attr("x", 20)
            .attr("y", y)
            .attr("font-family","sans-serif")
            .attr("dy", dy + "em");
        
        while (word = words.pop()) {
          line.push(word);
          tspan.text(line.join(" "));
          if (tspan.node().getComputedTextLength() > width(d)) {
            line.pop();
            tspan.text(line.join(" "));
            line = [word];
            tspan = text.append("tspan")
              .attr("x", 20)
              .attr("y", y)
              .attr("dy", ++lineNumber * lineHeight + dy + "em")
              .attr("font-family","sans-serif")
              .text(word);
          }
        }
      });
    }

    var socialite = {};
    
    socialite.listCalendars = function (){
    
      var request = gapi.client.calendar.calendarList.list();
      
      request.execute(function(resp) {

        var got_first_calendar = false;
        for (var i = 0; i < resp.items.length; i++){

          if(resp.items[i].accessRole=="owner"){
          
            $("#calendar_options").append("<li data-id='"+resp.items[i].id+"'><a href='#'>"+resp.items[i].summary+"</a></li>");
            
            if(!got_first_calendar){
              currentCalendar = resp.items[i].id;
              $("#select_calendar span.ui-button-text").text(resp.items[i].summary);
              got_first_calendar= true;
            }
            
            if((typeof(Storage)!=="undefined")&&(localStorage.currentCalendar)&&(localStorage.currentCalendar==resp.items[i].id)){
              currentCalendar = localStorage.currentCalendar;
              $("#select_calendar span.ui-button-text").text(resp.items[i].summary);
            }
          }
        }
        
        $("#calendar_options").menu({
          select: setCurrentCalendar
        });
        
        $("#add_to_calendar_div").show();
      });
    };

    
    socialite.resetPeriodDialog = function (){

    $( "#dialog" ).dialog({
      width: 700
    });
  
    $( "#datepicker" ).datepicker({
      onSelect: updateLastPeriod
    });
    newLastPeriod = lastPeriod;
    $( "#datepicker" ).datepicker( "setDate", lastPeriod );  
    
    $( "#spinner" ).spinner({
      change: updateInterval
    });
    $( "#spinner" ).spinner( "value", cycle_length );
    newInterval = cycle_length;
  
    $( "#dialog" ).dialog("open");
    
  };
  
    socialite.getPeriodEvent = function (name){
    
      var currentDate = new Date();
    
      var request = gapi.client.calendar.events.list({
        'calendarId': currentCalendar,
        'timeMin': currentDate.toISOString(),
        'q': "me time"
      });
    
      request.execute(function(resp) {
    
        if(resp.error){ 
          alert("failed to find event '"+name+"'");
        }else{
          periodEvent = resp.items[0];
          var eventId = periodEvent.id;
          var reccurence = periodEvent.recurrence[0];
          reccurence = reccurence.slice(reccurence.search("INTERVAL=")).split(";")[0];
          cycle_length = reccurence.split("=")[1];

          getNextOccurance(eventId);
        }
      });
    };
    
    socialite.resetPeriod = function (){
      periodEvent.recurrence[0]+= (";UNTIL="+ getActualLast());
    periodEvent.sequence++;
  
    var request = gapi.client.calendar.events.update({
      'calendarId': currentCalendar,
      'eventId': periodEvent.id,
      'resource': periodEvent
      }
    );
    
    
    request.execute(function(resp) {
    
      if(resp.error){ 
        alert("failed to delete");
      }else{    
        createNewPeriodEvent();
      }
    
    });
  
  };
  
    socialite.calculateStatistics =   function (){
      var currentDate = new Date(),
        yearAgo = new Date();
        
      yearAgo.setFullYear(currentDate.getFullYear()-1);
      
      var request = gapi.client.calendar.events.list({
        'calendarId': currentCalendar,
        'timeMin': yearAgo.toISOString(),
        'timeMax': currentDate.toISOString(),
        'q': "me time",
        'singleEvents': true
      });
      
      request.execute(function(resp) {
    
        if(resp.error){ 
          alert("failed to find event '"+name+"'");
        }else{
      
          var periodEvent,
            periodDate,
            length,
            lengths = 0,
            totalPeriodsCnt = resp.items.length,
            lastDate;
            
          var data=[];
        
          for (var i=0; i < totalPeriodsCnt; i++){
            periodEvent=resp.items[i];
            periodDate = new Date(periodEvent.start.date);
          
            if (i>0) {
              length = (periodDate-lastDate)/((24*3600*1000));
              lengths += length;
              data[i-1] = {
                date: lastDate,
                close: length,
                cycleEnded: periodDate
              };
            }
            lastDate = periodDate;
          }
        
          var avg= lengths/(totalPeriodsCnt-1);
        
          $("#chart").show();
          $("#avg-cycle-length").text(avg);
        
          draw_chart(data);
        }
      });
    };
  
    
    socialite.initDom = function () {
      $("#resetPeriodBtn").button().click(socialite.resetPeriodDialog);
      $("#search-calendar").button().click(socialite.getPeriodEvent);
      $("#newLastPeriodBtn").button().click(socialite.resetPeriod);
      $("#statisticsBtn").button().click(socialite.calculateStatistics);
      
      $("#select_calendar")
        .button({
          label: "test",
          icons: {
            secondary: "ui-icon-triangle-1-s"
          }
        })
        .click(function() {
          var menu = $("#calendar_options")
            .show()
            .position({
              my: "left top",
              at: "left bottom",
              of: this
            });
            
          $( document ).one( "click", function() {
            menu.hide();
          }); 
          return false;
        })
        .parent()
        .buttonset();
    };
    
    
    socialite.handleAuthResult = function (authResult) {
  
    if (authResult && !authResult.error) {
      gapi.client.load('calendar', 'v3', Socialite.listCalendars);
    }
    else {
          gapi.auth.authorize({
      'client_id': '236313466679-j8jhaf0h99u63c2523gr45mtgdsbrgi7.apps.googleusercontent.com',
      'scope': 'https://www.googleapis.com/auth/calendar',
      'immediate': false
    }, socialite.handleAuthResult);
    }
  }; 
    
  socialite.gapiLoaded = function (){
    gapi.client.setApiKey('AIzaSyBLYlu4hbmzhr1iOCiD_o2PTrjzvQBuQUA');
    gapi.auth.authorize({
      'client_id': '236313466679-j8jhaf0h99u63c2523gr45mtgdsbrgi7.apps.googleusercontent.com',
      'scope': 'https://www.googleapis.com/auth/calendar',
      'immediate': true
    }, Socialite.handleAuthResult);
  };
  return socialite;
}());
  var gapiLoaded = Socialite.gapiLoaded;
  $(Socialite.initDom);


  </script>

</head>
<body>
<div id="fb-root"></div>
<div id="content">
  <h1>SociaLYTE</h1>
  <p> Making the most out of your social networks</p>
  <div class="step" id="add_to_calendar_div" style="display: none">
    <div>
      <button id="search-calendar">Track Periods from </button>
      <button id="select_calendar"></button>
    </div>
    
    
    <ul id="calendar_options" style="display:none"></ul>
  </div>
  
  <div class="step" id="dateDisplays" style="display: none;">
    <p> Your last period started on <span id="lastPeriod" class="feature-number"> </span> <button id="resetPeriodBtn">change</button></p>
    <p> The next period should start <span id="cycle-length-txt" class="feature-number"></span> days later on <span id="nextPeriod" class="feature-number"> </span></p>
    
    <button id="statisticsBtn">Statistics</button></p>
  </div>
  <div class="step" id="chart" style="display: none;">
    <p> Over the past year, your average cycle length has been <span id="avg-cycle-length" class="feature-number"> </span></p>
  </div>
<div>

<div id="dialog" title="Reset Period" style="display: none;">
  <div id="datepicker"></div>
  <input id="spinner" name="value">
  <button id="newLastPeriodBtn">Reset Period</button>
</div>

</body>
</html>